#!/bin/bash

# Claude Code Multi-Provider Launcher v1.0
# Switch between Anthropic subscription/API and alternative backends
# Usage: cc-launcher [provider] [claude-args...]

set -e

# Provider configurations (using regular arrays for compatibility)
PROVIDERS_MOONSHOT="https://api.moonshot.ai/anthropic"
PROVIDERS_ANTHROPIC="https://api.anthropic.com"
PROVIDERS_DEEPSEEK="https://api.deepseek.com/anthropic"
PROVIDERS_ZHIPU="https://api.z.ai/api/anthropic"
PROVIDERS_MINIMAX="https://api.minimax.io/anthropic"
PROVIDERS_LLAMA_SERVER="http://localhost:8080"
PROVIDERS_OLLAMA="http://localhost:11434"
PROVIDERS_LMSTUDIO="http://localhost:1234"
PROVIDERS_LLAMABARN="http://localhost:2276"

MODELS_MOONSHOT_OPUS="kimi-k2.5"
MODELS_MOONSHOT="kimi-k2-turbo-preview"
MODELS_ANTHROPIC="claude-sonnet-4-5"
MODELS_DEEPSEEK="deepseek-chat"
MODELS_DEEPSEEK_FAST="deepseek-chat"
MODELS_ZHIPU="GLM-4.7"
MODELS_ZHIPU_FAST="GLM-4.7-Flash"
MODELS_MINIMAX="MiniMax-M2.1"
MODELS_MINIMAX_FAST="MiniMax-M2.1-lightning"

# Get provider URL
get_provider_url() {
    case $1 in
        "moonshot") echo "$PROVIDERS_MOONSHOT" ;;
        "anthropic") echo "$PROVIDERS_ANTHROPIC" ;;
        "deepseek") echo "$PROVIDERS_DEEPSEEK" ;;
        "zhipu") echo "$PROVIDERS_ZHIPU" ;;
        "minimax") echo "$PROVIDERS_MINIMAX" ;;
        "llama-server") echo "$PROVIDERS_LLAMA_SERVER" ;;
        "ollama") echo "$PROVIDERS_OLLAMA" ;;
        "lmstudio") echo "$PROVIDERS_LMSTUDIO" ;;
        "llamabarn") echo "$PROVIDERS_LLAMABARN" ;;
    esac
}

# Get provider model
get_provider_model() {
    case $1 in
        "moonshot") echo "$MODELS_MOONSHOT" ;;
        "anthropic") echo "$MODELS_ANTHROPIC" ;;
        "deepseek") echo "$MODELS_DEEPSEEK" ;;
        "zhipu") echo "$MODELS_ZHIPU" ;;
        "minimax") echo "$MODELS_MINIMAX" ;;
        "llama-server"|"ollama"|"lmstudio"|"llamabarn") echo "" ;;
    esac
}

get_provider_fast_model() {
    case $1 in
        "zhipu") echo "$MODELS_ZHIPU_FAST" ;;
        "deepseek") echo "$MODELS_DEEPSEEK_FAST" ;;
        "minimax") echo "$MODELS_MINIMAX_FAST" ;;
        *) get_provider_model "$1" ;;
    esac
}

# Check if environment variable exists (lazy checking)
check_env_var() {
    local var_name=$1
    local provider=$2

    if [[ -z "${!var_name:-}" ]]; then
        echo "Error: $provider requires $var_name environment variable" >&2
        echo "Please set $var_name and try again" >&2
        exit 1
    fi
}

# Prompt user for API key interactively
prompt_for_api_key() {
    local provider_name="$1"
    if [[ -t 0 ]]; then  # Running in TTY
        read -rs -p "Enter $provider_name API key: " api_key
        echo >&2
        if [[ -n "$api_key" ]]; then
            echo "$api_key"
        else
            echo "Error: No API key provided" >&2
            exit 1
        fi
    else
        echo "Error: No API key found and not running in TTY" >&2
        echo "Please set the appropriate environment variable or pass API key as argument" >&2
        exit 1
    fi
}

# Get API key for provider (with optional inline key and prompt fallback)
# Usage: get_api_key_with_fallback <provider> [inline_key]
get_api_key_with_fallback() {
    local provider="$1"
    local inline_key="${2:-}"
    local provider_name="$3"

    # Try inline key first
    if [[ -n "$inline_key" ]]; then
        echo "$inline_key"
        return
    fi

    # Try environment variables
    case $provider in
        "moonshot")
            if [[ -n "${MOONSHOT_API_KEY:-}" ]]; then
                echo "${MOONSHOT_API_KEY}"
                return
            fi
            ;;
        "anthropic")
            if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
                echo "${ANTHROPIC_API_KEY}"
                return
            elif [[ -n "${ANTHROPIC_AUTH_TOKEN:-}" ]]; then
                echo "${ANTHROPIC_AUTH_TOKEN}"
                return
            fi
            ;;
        "deepseek")
            if [[ -n "${DEEPSEEK_API_KEY:-}" ]]; then
                echo "${DEEPSEEK_API_KEY}"
                return
            fi
            ;;
        "zhipu")
            if [[ -n "${ZAI_API_KEY:-}" ]]; then
                echo "${ZAI_API_KEY}"
                return
            elif [[ -n "${ZHIPUAI_API_KEY:-}" ]]; then
                echo "${ZHIPUAI_API_KEY}"
                return
            fi
            ;;
        "minimax")
            if [[ -n "${MINIMAX_API_KEY:-}" ]]; then
                echo "${MINIMAX_API_KEY}"
                return
            fi
            ;;
        "llama-server"|"ollama"|"lmstudio"|"llamabarn")
            echo "none"
            return
            ;;
        "custom")
            # No env vars for custom URLs
            ;;
    esac

    # If we get here and it's not a local server, prompt for key
    if [[ "$provider" != "llama-server" ]] && [[ "$provider" != "ollama" ]] && \
       [[ "$provider" != "lmstudio" ]] && [[ "$provider" != "llamabarn" ]]; then
        prompt_for_api_key "$provider_name"
    fi
}

# Legacy get_api_key for backward compatibility (exits on error)
get_api_key() {
    local result
    if result=$(get_api_key_with_fallback "$1" "" "$1"); then
        echo "$result"
    else
        exit 1
    fi
}

# ANSI color codes
if [[ -t 1 ]]; then
    C_RESET=$'\033[0m'
    C_BOLD=$'\033[1m'
    C_DIM=$'\033[2m'
    C_CYAN=$'\033[36m'
    C_YELLOW=$'\033[33m'
    C_GREEN=$'\033[32m'
else
    C_RESET=''
    C_BOLD=''
    C_DIM=''
    C_CYAN=''
    C_YELLOW=''
    C_GREEN=''
fi

# Redact API key for display (show first 4 and last 4 chars)
redact_key() {
    local key="$1"
    local len=${#key}
    if [[ $len -le 12 ]]; then
        echo "${key:0:2}...${key: -2}"
    else
        echo "${key:0:4}...${key: -4}"
    fi
}

# Format env var with color (name in yellow, value after =)
fmt_env() {
    local name="$1"
    local value="$2"
    if [[ -n "$value" ]]; then
        echo -e "${C_YELLOW}${name}${C_RESET}=$(redact_key "$value")"
    else
        echo -e "${C_YELLOW}${name}${C_RESET}=${C_DIM}(not set)${C_RESET}"
    fi
}

# Format model name with color
fmt_model() {
    echo -e "${C_GREEN}$1${C_RESET}"
}

# Parse and set model tiers from comma-separated string
# 1 model: all tiers get it
# 2 models (a,b): opus=a, sonnet=a, haiku=b
# 3 models (a,b,c): opus=a, sonnet=b, haiku=c
set_model_tiers() {
    local model_str="$1"

    if [[ -z "$model_str" ]]; then
        return
    fi

    # Split by comma (portable method)
    local IFS=','
    # shellcheck disable=SC2086  # Intentional word splitting
    set -- $model_str
    local count=$#

    case $count in
        1)
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$1"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$1"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$1"
            ;;
        2)
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$1"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$1"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$2"
            ;;
        3)
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$1"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$2"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$3"
            ;;
        *)
            echo "Error: Model string should have 1-3 comma-separated values" >&2
            exit 1
            ;;
    esac
}

# Format provider name with color
fmt_provider() {
    echo -e "${C_CYAN}${C_BOLD}$1${C_RESET}"
}

# Get API key status for a provider
get_key_status() {
    local provider="$1"
    case "$provider" in
        "subscription")
            if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
                fmt_env "CLAUDE_CODE_OAUTH_TOKEN" "$CLAUDE_CODE_OAUTH_TOKEN"
            else
                echo -e "${C_DIM}(stored auth or login)${C_RESET}"
            fi
            ;;
        "anthropic")
            if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
                fmt_env "ANTHROPIC_API_KEY" "$ANTHROPIC_API_KEY"
            elif [[ -n "${ANTHROPIC_AUTH_TOKEN:-}" ]]; then
                fmt_env "ANTHROPIC_AUTH_TOKEN" "$ANTHROPIC_AUTH_TOKEN"
            else
                echo -e "${C_YELLOW}ANTHROPIC_API_KEY${C_RESET}=${C_DIM}(not set)${C_RESET}"
            fi
            ;;
        "deepseek")
            fmt_env "DEEPSEEK_API_KEY" "${DEEPSEEK_API_KEY:-}"
            ;;
        "zhipu")
            if [[ -n "${ZAI_API_KEY:-}" ]]; then
                fmt_env "ZAI_API_KEY" "$ZAI_API_KEY"
            elif [[ -n "${ZHIPUAI_API_KEY:-}" ]]; then
                fmt_env "ZHIPUAI_API_KEY" "$ZHIPUAI_API_KEY"
            else
                fmt_env "ZAI_API_KEY" ""
            fi
            ;;
        "moonshot")
            if [[ -n "${MOONSHOT_API_KEY:-}" ]]; then
                fmt_env "MOONSHOT_API_KEY" "$MOONSHOT_API_KEY"
            else
                fmt_env "MOONSHOT_API_KEY" ""
            fi
            ;;
        "minimax")
            fmt_env "MINIMAX_API_KEY" "${MINIMAX_API_KEY:-}"
            ;;
        *)
            echo "-"
            ;;
    esac
}

# Show a provider entry (two lines: provider/url/auth, then models)
show_provider_entry() {
    local provider="$1"
    local url="$2"
    local auth="$3"
    local models="$4"

    # First line: provider, URL, auth
    echo -e "  ${C_CYAN}${C_BOLD}${provider}${C_RESET}"
    echo -e "      URL:  ${C_DIM}${url}${C_RESET}"
    echo -e "      Auth: ${auth}"
    if [[ -n "$models" ]]; then
        echo -e "      Models: ${models}"
    fi
    echo ""
}

# Show provider table
show_providers() {
    local col2=30  # URL column width

    echo "PROVIDERS:"

    # Subscription & Anthropic API
    printf "  ${C_CYAN}${C_BOLD}%-12s${C_RESET} %-${col2}s %b\n" "subscription" "" "$(get_key_status subscription)"
    echo -e "    ${C_DIM}(sub)${C_RESET}"
    printf "  ${C_CYAN}${C_BOLD}%-12s${C_RESET} ${C_DIM}%-${col2}s${C_RESET} %b\n" "anthropic" "api.anthropic.com" "$(get_key_status anthropic)"

    # Third-party providers
    printf "  ${C_CYAN}${C_BOLD}%-12s${C_RESET} ${C_DIM}%-${col2}s${C_RESET} %b\n" "deepseek" "api.deepseek.com/anthropic" "$(get_key_status deepseek)"
    echo -e "               $(fmt_model "$MODELS_DEEPSEEK")"

    printf "  ${C_CYAN}${C_BOLD}%-12s${C_RESET} ${C_DIM}%-${col2}s${C_RESET} %b\n" "zhipu" "api.z.ai/api/anthropic" "$(get_key_status zhipu)"
    echo -e "    ${C_DIM}(zai)${C_RESET}      $(fmt_model "$MODELS_ZHIPU"), $(fmt_model "$MODELS_ZHIPU_FAST")"

    printf "  ${C_CYAN}${C_BOLD}%-12s${C_RESET} ${C_DIM}%-${col2}s${C_RESET} %b\n" "moonshot" "api.moonshot.ai/anthropic" "$(get_key_status moonshot)"
    echo -e "    ${C_DIM}(kimi)${C_RESET}     $(fmt_model "$MODELS_MOONSHOT_OPUS"), $(fmt_model "$MODELS_MOONSHOT")"

    printf "  ${C_CYAN}${C_BOLD}%-12s${C_RESET} ${C_DIM}%-${col2}s${C_RESET} %b\n" "minimax" "api.minimax.io/anthropic" "$(get_key_status minimax)"
    echo -e "               $(fmt_model "$MODELS_MINIMAX"), $(fmt_model "$MODELS_MINIMAX_FAST")"

    # Local servers
    echo -e "  ${C_DIM}── local servers [model] ──${C_RESET}"
    echo -e "  ${C_CYAN}${C_BOLD}ollama${C_RESET}       ${C_DIM}localhost:11434${C_RESET}    ${C_CYAN}${C_BOLD}lmstudio${C_RESET}     ${C_DIM}localhost:1234${C_RESET}"
    echo -e "  ${C_CYAN}${C_BOLD}llama-server${C_RESET} ${C_DIM}localhost:8080${C_RESET}     ${C_CYAN}${C_BOLD}llamabarn${C_RESET}    ${C_DIM}localhost:2276${C_RESET}"

    # Custom URL
    echo -e "  ${C_DIM}── custom url ──${C_RESET}"
    echo -e "  ${C_CYAN}${C_BOLD}http(s)://...${C_RESET} ${C_DIM}<key> [model]${C_RESET}  Any Anthropic-compatible endpoint"
}

# Show usage
usage() {
    cat << 'EOF'
Claude Code Multi-Provider Launcher v1.0

USAGE:  cc-launcher [PROVIDER] [KEY] [--] [claude-args...]
        cc-launcher <LOCAL-SERVER> [MODEL] [--] [claude-args...]
        cc-launcher <URL> <KEY> [MODEL] [--] [claude-args...]

EXAMPLES:
    cc-launcher                            # Claude subscription (default)
    cc-launcher deepseek                   # Use env key or prompt
    cc-launcher ollama "gpt-oss"           # Local server with model
    cc-launcher ollama "big,small"         # 2 models: opus+sonnet=big, haiku=small
    cc-launcher ollama "huge,big,small"    # 3 models: opus=huge, sonnet=big, haiku=small
    cc-launcher "https://..." "key" "model"

MODEL:  "m"       all tiers use m
        "a,b"     opus+sonnet=a  haiku=b
        "a,b,c"   opus=a  sonnet=b  haiku=c
EOF
    echo ""
    show_providers
}

# Main launcher
main() {
    local first_arg="${1:-sub}"
    local second_arg="${2:-}"

    # Handle help flag
    if [[ "$first_arg" == "--help" ]] || [[ "$first_arg" == "-h" ]]; then
        usage
        exit 0
    fi

    # Detect if first arg is a custom URL (starts with http:// or https://)
    if [[ "$first_arg" =~ ^https?:// ]]; then
        # Custom URL mode
        local custom_url="$first_arg"
        local inline_key="$second_arg"
        local custom_model="${3:-}"

        # Shift args for remaining claude args
        if [[ $# -ge 3 ]] && [[ -n "$custom_model" ]]; then
            shift 3
        elif [[ $# -ge 2 ]]; then
            shift 2
        elif [[ $# -ge 1 ]]; then
            shift
        fi

        # Get API key: inline (empty string = no key) → prompt
        local api_key="$inline_key"
        if [[ -z "$api_key" ]] && [[ "$second_arg" != "" ]]; then
            # No second arg provided at all, prompt for key
            api_key=$(prompt_for_api_key "custom API")
        fi

        export ANTHROPIC_BASE_URL="$custom_url"
        if [[ -n "$api_key" ]]; then
            export ANTHROPIC_AUTH_TOKEN="$api_key"
        fi

        # If model is provided, parse and set tier vars
        if [[ -n "$custom_model" ]]; then
            set_model_tiers "$custom_model"
            echo "Using custom URL: $custom_url with model: $custom_model" >&2
        else
            echo "Using custom URL: $custom_url" >&2
        fi

        # Disable telemetry and non-essential traffic for privacy
        export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

        exec claude "$@"
    fi

    # Check if it's a local server provider (handle separately for key/model args)
    local local_server_url=""
    case "$first_arg" in
        "llama-server") local_server_url="$PROVIDERS_LLAMA_SERVER" ;;
        "ollama") local_server_url="$PROVIDERS_OLLAMA" ;;
        "lmstudio"|"lm-studio") local_server_url="$PROVIDERS_LMSTUDIO" ;;
        "llamabarn"|"llama-barn") local_server_url="$PROVIDERS_LLAMABARN" ;;
    esac

    if [[ -n "$local_server_url" ]]; then
        local provider_name="$first_arg"
        local custom_model=""

        # Second arg is model only if it doesn't start with -
        if [[ -n "$second_arg" ]] && [[ "$second_arg" != -* ]]; then
            custom_model="$second_arg"
        fi

        # Shift args for remaining claude args
        if [[ $# -ge 2 ]] && [[ -n "$custom_model" ]]; then
            shift 2
        elif [[ $# -ge 1 ]]; then
            shift
        fi

        export ANTHROPIC_BASE_URL="$local_server_url"

        # If model is provided, parse and set tier vars
        if [[ -n "$custom_model" ]]; then
            set_model_tiers "$custom_model"
            echo "Using $provider_name: $local_server_url with model: $custom_model" >&2
        else
            echo "Using $provider_name: $local_server_url" >&2
        fi

        # Disable telemetry and non-essential traffic for privacy
        export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

        exec claude "$@"
    fi

    # Preset provider mode
    local provider="$first_arg"
    local inline_key="$second_arg"
    local provider_mode=""
    local provider_base=""

    # Map provider aliases to canonical names
    case "$provider" in
        "subscription"|"sub")
            provider_mode="subscription"
            provider_base="anthropic"
            ;;
        "anthropic"|"api")
            provider_mode="anthropic"
            provider_base="anthropic"
            ;;
        "moonshot"|"kimi")
            provider_mode="moonshot"
            provider_base="moonshot"
            ;;
        "deepseek")
            provider_mode="deepseek"
            provider_base="deepseek"
            ;;
        "zhipu"|"zai"|"glm")
            provider_mode="zhipu"
            provider_base="zhipu"
            ;;
        "minimax")
            provider_mode="minimax"
            provider_base="minimax"
            ;;
        *)
            echo "Error: Unknown provider '$provider'" >&2
            echo "Available: subscription (sub) api moonshot (kimi) deepseek zhipu (zai glm) minimax llama-server ollama lmstudio llamabarn" >&2
            echo "You can also use a custom URL directly as the first argument" >&2
            exit 1
            ;;
    esac

    if [[ "$provider_mode" == "subscription" ]]; then
        if [[ $# -gt 0 ]]; then
            shift
        fi
        if [[ -n "$second_arg" ]]; then
            shift
        fi

        if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
            echo "Ignoring Claude API key environment variables for subscription mode" >&2
        fi
        unset ANTHROPIC_API_KEY

        if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
            echo "Using Claude subscription via CLAUDE_CODE_OAUTH_TOKEN" >&2
        else
            echo "Launching Claude subscription; relying on macOS Keychain or interactive login if needed" >&2
        fi

        exec claude "$@"
    fi

    if [[ "$provider_mode" == "anthropic" ]]; then
        if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
            echo "Ignoring CLAUDE_CODE_OAUTH_TOKEN in Anthropic API mode" >&2
            unset CLAUDE_CODE_OAUTH_TOKEN
        fi
        echo "Using Anthropic API" >&2
    fi

    # Shift args: provider name, and optional inline key
    if [[ $# -gt 0 ]]; then
        shift
    fi
    if [[ -n "$second_arg" ]]; then
        shift
    fi

    # Get API key: inline → env vars → prompt
    local api_key
    local provider_display_name="$provider_base"
    [[ "$provider_base" == "zhipu" ]] && provider_display_name="Zhipu"
    [[ "$provider_base" == "moonshot" ]] && provider_display_name="Moonshot"

    api_key=$(get_api_key_with_fallback "$provider_base" "$inline_key" "$provider_display_name")

    local base_url
    base_url="$(get_provider_url "$provider_base")"
    export ANTHROPIC_BASE_URL="$base_url"
    export ANTHROPIC_AUTH_TOKEN="$api_key"

    # Map Claude model aliases to provider's models
    # For alternative providers without true tiers, map all aliases to their best model
    case "$provider_base" in
        "moonshot")
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$MODELS_MOONSHOT_OPUS"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$MODELS_MOONSHOT"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$MODELS_MOONSHOT"
            ;;
        "deepseek")
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$MODELS_DEEPSEEK"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$MODELS_DEEPSEEK"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$MODELS_DEEPSEEK"
            ;;
        "minimax")
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$MODELS_MINIMAX"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$MODELS_MINIMAX"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$MODELS_MINIMAX_FAST"
            ;;
        "zhipu")
            export ANTHROPIC_DEFAULT_OPUS_MODEL="$MODELS_ZHIPU"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="$MODELS_ZHIPU"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="$MODELS_ZHIPU_FAST"
            ;;
        "anthropic")
            # For official Anthropic, let Claude Code use defaults
            unset ANTHROPIC_DEFAULT_OPUS_MODEL
            unset ANTHROPIC_DEFAULT_SONNET_MODEL
            unset ANTHROPIC_DEFAULT_HAIKU_MODEL
            ;;
    esac

    # Disable telemetry and non-essential traffic for privacy
    export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

    exec claude "$@"
}

# Run main function
main "$@"
